name: Check Epson Printer Stock

on:
  push:
    branches: [main]
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allows manual trigger from GitHub

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
      - name: Check Stock Status
        id: check
        run: |
          echo "ðŸ” Checking Epson ET-8550 stock status..."
          
          # Fetch the product page
          RESPONSE=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N")
          
          echo ""
          echo "=== DEBUG: Checking Specific HTML Elements ==="
          echo "Found 'visible-lg out' class: $(echo "$RESPONSE" | grep -c 'visible-lg out')"
          echo "Found 'visible-lg refurbished' class: $(echo "$RESPONSE" | grep -c 'visible-lg refurbished')"
          echo "Found 'Out of Stock' text: $(echo "$RESPONSE" | grep -c '>Out of Stock<')"
          echo "Found 'Certified ReNew' in promo: $(echo "$RESPONSE" | grep -c 'promo-bug.*Certified ReNew')"
          
          echo ""
          echo "=== Looking for promo-bug div ==="
          echo "$RESPONSE" | grep -o 'class="pull-right promo-bug[^>]*>[^<]*' | head -5
          
          echo ""
          echo "=== STOCK DETECTION LOGIC ==="
          
          # PRECISE CHECK: Look for the exact HTML structure you found
          # Out of stock: <div class="pull-right promo-bug visible-md visible-lg out">Out of Stock</div>
          # In stock: <div class="pull-right promo-bug visible-md visible-lg refurbished">Certified ReNew</div>
          
          if echo "$RESPONSE" | grep -q 'visible-lg out'; then
            echo "âœ… DETECTION: Found 'visible-lg out' class - This is OUT OF STOCK"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'visible-lg refurbished'; then
            echo "âœ… DETECTION: Found 'visible-lg refurbished' class - This is IN STOCK"
            echo "status=in-stock" >> $GITHUB_OUTPUT
            
          else
            echo "âš ï¸ DETECTION: Could not find expected classes - defaulting to OUT OF STOCK"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "Final status: $(cat $GITHUB_OUTPUT | grep status | cut -d'=' -f2)"
      
      - name: Send Discord Notification (In Stock!)
        if: steps.check.outputs.status == 'in-stock'
        run: |
          echo "ðŸ“¢ Sending IN STOCK notification to Discord..."
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png",
              "content": "@everyone ðŸš¨ **PRINTER ALERT** ðŸš¨",
              "embeds": [{
                "title": "ðŸŽ‰ EPSON PRINTER BACK IN STOCK!",
                "description": "**The EcoTank ET-8550 is now available for purchase!**\n\nðŸƒâ€â™‚ï¸ **ACT FAST** - This sells out quickly!",
                "color": 1096065,
                "fields": [
                  {
                    "name": "ðŸ“¦ Product",
                    "value": "EcoTank Photo ET-8550 Wide-format Supertank Printer (Certified ReNew)",
                    "inline": false
                  },
                  {
                    "name": "ðŸ’° Price",
                    "value": "$479.99",
                    "inline": true
                  },
                  {
                    "name": "â° Status",
                    "value": "**IN STOCK NOW** âœ…",
                    "inline": true
                  },
                  {
                    "name": "ðŸ”— Purchase Link",
                    "value": "[**>>> CLICK HERE TO BUY NOW <<<**](https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N)",
                    "inline": false
                  }
                ],
                "thumbnail": {
                  "url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
                },
                "footer": {
                  "text": "Stock Tracker â€¢ Checked every 10 minutes"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "âœ… Discord notification sent!"
      
      - name: Send Discord Notification (Out of Stock - Hourly)
        if: steps.check.outputs.status == 'out-of-stock'
        run: |
          # Calculate if we should send hourly update (every 6 runs)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 6))
          
          if [ $REMAINDER -eq 0 ]; then
            echo "ðŸ“¢ Sending hourly OUT OF STOCK update to Discord..."
            curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "Stock Tracker Bot",
                "embeds": [{
                  "title": "ðŸ“Š Hourly Status Update",
                  "description": "Still monitoring - printer is currently out of stock",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "Status",
                      "value": "Out of Stock âŒ",
                      "inline": true
                    },
                    {
                      "name": "Next Check",
                      "value": "In 10 minutes",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "You will be notified immediately when back in stock"
                  },
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                }]
              }'
            echo "âœ… Hourly update sent"
          else
            echo "â„¹ï¸ Skipping hourly update (run #$RUN_NUM, sends every 6 runs)"
          fi
