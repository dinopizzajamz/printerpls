name: Check Epson Printer Stock

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allows manual trigger from GitHub

jobs:
  check-stock:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Stock Status
        id: check
        run: |
          echo "üîç Checking Epson ET-8550 stock status..."
          
          # Fetch the product page
          RESPONSE=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N")
          
          # Debug: Save response to artifact for troubleshooting
          echo "$RESPONSE" > page_content.txt
          
          # Check stock status with multiple indicators
          # The page shows "Out of Stock" text and disabled "Buy Now" button when unavailable
          
          if echo "$RESPONSE" | grep -q "Out of Stock"; then
            echo "‚ùå Product is OUT OF STOCK (found 'Out of Stock' text)"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'Buy Now.*disabled\|disabled.*Buy Now'; then
            echo "‚ùå Product is OUT OF STOCK (Buy Now button is disabled)"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q "Error While Adding"; then
            echo "‚ùå Product is OUT OF STOCK (Error While Adding indicator)"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -iq "Add to Cart\|Buy Now" && ! echo "$RESPONSE" | grep -q "Out of Stock"; then
            # Only mark as in-stock if we see purchase buttons AND no out-of-stock text
            echo "‚úÖ Product appears to be IN STOCK!"
            echo "status=in-stock" >> $GITHUB_OUTPUT
            
          else
            echo "‚ö†Ô∏è Unable to determine status clearly - treating as out of stock to avoid false positives"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi
          
          # Show what we found for debugging
          echo ""
          echo "=== Key Indicators Found ==="
          echo "Out of Stock text: $(echo "$RESPONSE" | grep -c "Out of Stock")"
          echo "Buy Now button: $(echo "$RESPONSE" | grep -c "Buy Now")"
          echo "Add to Cart: $(echo "$RESPONSE" | grep -c "Add to Cart")"
          echo "Error While Adding: $(echo "$RESPONSE" | grep -c "Error While Adding")"
      
      - name: Upload Debug Info
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: page-content-debug
          path: page_content.txt
          retention-days: 1
      
      - name: Send Discord Notification (In Stock!)
        if: steps.check.outputs.status == 'in-stock'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png",
              "content": "@everyone üö® **PRINTER ALERT** üö®",
              "embeds": [{
                "title": "üéâ EPSON PRINTER BACK IN STOCK!",
                "description": "**The EcoTank ET-8550 is now available for purchase!**\n\nüèÉ‚Äç‚ôÇÔ∏è **ACT FAST** - This sells out quickly!",
                "color": 1096065,
                "fields": [
                  {
                    "name": "üì¶ Product",
                    "value": "EcoTank Photo ET-8550 Wide-format Supertank Printer (Certified ReNew)",
                    "inline": false
                  },
                  {
                    "name": "üí∞ Price",
                    "value": "$479.99",
                    "inline": true
                  },
                  {
                    "name": "‚è∞ Status",
                    "value": "**IN STOCK NOW** ‚úÖ",
                    "inline": true
                  },
                  {
                    "name": "üîó Purchase Link",
                    "value": "[**>>> CLICK HERE TO BUY NOW <<<**](https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N)",
                    "inline": false
                  }
                ],
                "thumbnail": {
                  "url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
                },
                "footer": {
                  "text": "Stock Tracker ‚Ä¢ Checked every 10 minutes"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚úÖ IN-STOCK Discord notification sent!"
      
      - name: Calculate if hourly update needed
        if: steps.check.outputs.status == 'out-of-stock'
        id: hourly
        run: |
          # Send update every 6 runs (10 min * 6 = hourly)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 6))
          if [ $REMAINDER -eq 0 ]; then
            echo "send=true" >> $GITHUB_OUTPUT
          else
            echo "send=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord Notification (Still Out of Stock)
        if: steps.check.outputs.status == 'out-of-stock' && steps.hourly.outputs.send == 'true'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "embeds": [{
                "title": "üìä Hourly Status Update",
                "description": "Still monitoring - printer is currently out of stock",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Status",
                    "value": "Out of Stock ‚ùå",
                    "inline": true
                  },
                  {
                    "name": "Next Check",
                    "value": "In 10 minutes",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "You will be notified immediately when back in stock"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚ÑπÔ∏è Hourly update sent to Discord"
      
      - name: Calculate if daily alert needed
        if: steps.check.outputs.status == 'unknown'
        id: daily
        run: |
          # Send alert once per day (144 runs at 10min = 24 hours)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 144))
          if [ $REMAINDER -eq 0 ]; then
            echo "send=true" >> $GITHUB_OUTPUT
          else
            echo "send=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord Notification (Status Unknown)
        if: steps.check.outputs.status == 'unknown' && steps.daily.outputs.send == 'true'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "embeds": [{
                "title": "‚ö†Ô∏è Status Check Warning",
                "description": "Unable to determine stock status clearly. Website may have changed or be temporarily down.",
                "color": 16776960,
                "fields": [
                  {
                    "name": "Action Needed",
                    "value": "Check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions) for details",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Monitoring continues - treating as out of stock for safety"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚ö†Ô∏è Unknown status alert sent"