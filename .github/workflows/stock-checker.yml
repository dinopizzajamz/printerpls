name: Check Epson Printer Stock

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allows manual trigger from GitHub

jobs:
  check-stock:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Stock Status
        id: check
        run: |
          echo "üîç Checking Epson ET-8550 stock status..."
          
          # Fetch the product page
          RESPONSE=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N")
          
          # Save response for debugging
          echo "$RESPONSE" > page_content.txt
          
          # PRECISE CHECK: Look for the exact HTML structure you found
          # Out of stock: <div class="pull-right promo-bug visible-md visible-lg out">Out of Stock</div>
          # In stock: <div class="pull-right promo-bug visible-md visible-lg refurbished">Certified ReNew</div>
          
          if echo "$RESPONSE" | grep -q 'class="pull-right promo-bug visible-md visible-lg out"'; then
            echo "‚ùå CONFIRMED OUT OF STOCK - Found the 'out' class in promo-bug div"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'visible-lg out.*Out of Stock'; then
            echo "‚ùå CONFIRMED OUT OF STOCK - Found 'visible-lg out' with 'Out of Stock' text"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'class="pull-right promo-bug visible-md visible-lg refurbished"'; then
            echo "‚úÖ CONFIRMED IN STOCK - Found the 'refurbished' class (not 'out')"
            echo "status=in-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q '>Out of Stock</div>'; then
            echo "‚ùå OUT OF STOCK - Found 'Out of Stock' closing div tag"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          else
            echo "‚ö†Ô∏è Unable to find expected HTML structure - treating as out of stock"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi
          
          # Detailed debugging
          echo ""
          echo "=== DEBUG: Checking Specific HTML Elements ==="
          echo "Found 'out' class: $(echo "$RESPONSE" | grep -c 'visible-lg out')"
          echo "Found 'refurbished' class: $(echo "$RESPONSE" | grep -c 'visible-lg refurbished')"
          echo "Found 'Out of Stock' text: $(echo "$RESPONSE" | grep -c '>Out of Stock<')"
          echo "Found 'Certified ReNew' text: $(echo "$RESPONSE" | grep -c '>Certified ReNew<')"
          
          # Show the actual promo-bug div if found
          echo ""
          echo "=== Promo Bug Div Content ==="
          echo "$RESPONSE" | grep -o 'class="pull-right promo-bug[^>]*>[^<]*' || echo "Not found"
      
      - name: Upload Debug Info
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: page-content-debug
          path: page_content.txt
          retention-days: 1
      
      - name: Send Discord Notification (In Stock!)
        if: steps.check.outputs.status == 'in-stock'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png",
              "content": "@everyone üö® **PRINTER ALERT** üö®",
              "embeds": [{
                "title": "üéâ EPSON PRINTER BACK IN STOCK!",
                "description": "**The EcoTank ET-8550 is now available for purchase!**\n\nüèÉ‚Äç‚ôÇÔ∏è **ACT FAST** - This sells out quickly!",
                "color": 1096065,
                "fields": [
                  {
                    "name": "üì¶ Product",
                    "value": "EcoTank Photo ET-8550 Wide-format Supertank Printer (Certified ReNew)",
                    "inline": false
                  },
                  {
                    "name": "üí∞ Price",
                    "value": "$479.99",
                    "inline": true
                  },
                  {
                    "name": "‚è∞ Status",
                    "value": "**IN STOCK NOW** ‚úÖ",
                    "inline": true
                  },
                  {
                    "name": "üîó Purchase Link",
                    "value": "[**>>> CLICK HERE TO BUY NOW <<<**](https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N)",
                    "inline": false
                  }
                ],
                "thumbnail": {
                  "url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
                },
                "footer": {
                  "text": "Stock Tracker ‚Ä¢ Checked every 10 minutes"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚úÖ IN-STOCK Discord notification sent!"
      
      - name: Calculate if hourly update needed
        if: steps.check.outputs.status == 'out-of-stock'
        id: hourly
        run: |
          # Send update every 6 runs (10 min * 6 = hourly)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 6))
          if [ $REMAINDER -eq 0 ]; then
            echo "send=true" >> $GITHUB_OUTPUT
          else
            echo "send=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord Notification (Still Out of Stock)
        if: steps.check.outputs.status == 'out-of-stock' && steps.hourly.outputs.send == 'true'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "embeds": [{
                "title": "üìä Hourly Status Update",
                "description": "Still monitoring - printer is currently out of stock",
                "color": 15158332,
                "fields": [
                  {
                    "name": "Status",
                    "value": "Out of Stock ‚ùå",
                    "inline": true
                  },
                  {
                    "name": "Next Check",
                    "value": "In 10 minutes",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "You will be notified immediately when back in stock"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚ÑπÔ∏è Hourly update sent to Discord"
      
      - name: Calculate if daily alert needed
        if: steps.check.outputs.status == 'unknown'
        id: daily
        run: |
          # Send alert once per day (144 runs at 10min = 24 hours)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 144))
          if [ $REMAINDER -eq 0 ]; then
            echo "send=true" >> $GITHUB_OUTPUT
          else
            echo "send=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Discord Notification (Status Unknown)
        if: steps.check.outputs.status == 'unknown' && steps.daily.outputs.send == 'true'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "embeds": [{
                "title": "‚ö†Ô∏è Status Check Warning",
                "description": "Unable to determine stock status clearly. Website may have changed or be temporarily down.",
                "color": 16776960,
                "fields": [
                  {
                    "name": "Action Needed",
                    "value": "Check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions) for details and download the page-content-debug artifact",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Monitoring continues - treating as out of stock for safety"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "‚ö†Ô∏è Unknown status alert sent"