name: Check Epson Printer Stock

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch: # Allows manual trigger from GitHub

jobs:
  check-stock:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Stock Status
        id: check
        run: |
          echo "ðŸ” Checking Epson ET-8550 stock status..."
          
          # Fetch the product page
          RESPONSE=$(curl -s -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N")
          
          # Save response for debugging
          echo "$RESPONSE" > page_content.txt
          
          # PRECISE CHECK: Look for the exact HTML structure you found
          # Out of stock: <div class="pull-right promo-bug visible-md visible-lg out">Out of Stock</div>
          # In stock: <div class="pull-right promo-bug visible-md visible-lg refurbished">Certified ReNew</div>
          
          if echo "$RESPONSE" | grep -q 'class="pull-right promo-bug visible-md visible-lg out"'; then
            echo "âŒ CONFIRMED OUT OF STOCK - Found the 'out' class in promo-bug div"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'visible-lg out.*Out of Stock'; then
            echo "âŒ CONFIRMED OUT OF STOCK - Found 'visible-lg out' with 'Out of Stock' text"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q 'class="pull-right promo-bug visible-md visible-lg refurbished"'; then
            echo "âœ… CONFIRMED IN STOCK - Found the 'refurbished' class (not 'out')"
            echo "status=in-stock" >> $GITHUB_OUTPUT
            
          elif echo "$RESPONSE" | grep -q '>Out of Stock</div>'; then
            echo "âŒ OUT OF STOCK - Found 'Out of Stock' closing div tag"
            echo "status=out-of-stock" >> $GITHUB_OUTPUT
            
          else
            echo "âš ï¸ Unable to find expected HTML structure - treating as out of stock"
            echo "status=unknown" >> $GITHUB_OUTPUT
          fi
          
          # Detailed debugging
          echo ""
          echo "=== DEBUG: Checking Specific HTML Elements ==="
          echo "Found 'out' class: $(echo "$RESPONSE" | grep -c 'visible-lg out')"
          echo "Found 'refurbished' class: $(echo "$RESPONSE" | grep -c 'visible-lg refurbished')"
          echo "Found 'Out of Stock' text: $(echo "$RESPONSE" | grep -c '>Out of Stock<')"
          echo "Found 'Certified ReNew' text: $(echo "$RESPONSE" | grep -c '>Certified ReNew<')"
          
          # Show the actual promo-bug div if found
          echo ""
          echo "=== Promo Bug Div Content ==="
          echo "$RESPONSE" | grep -o 'class="pull-right promo-bug[^>]*>[^<]*' || echo "Not found"
      
      - name: Upload Debug Info
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: page-content-debug
          path: page_content.txt
          retention-days: 1
      
      - name: Send Discord Notification (In Stock!)
        if: steps.check.outputs.status == 'in-stock'
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "username": "Stock Tracker Bot",
              "avatar_url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png",
              "content": "@everyone ðŸš¨ **PRINTER ALERT** ðŸš¨",
              "embeds": [{
                "title": "ðŸŽ‰ EPSON PRINTER BACK IN STOCK!",
                "description": "**The EcoTank ET-8550 is now available for purchase!**\n\nðŸƒâ€â™‚ï¸ **ACT FAST** - This sells out quickly!",
                "color": 1096065,
                "fields": [
                  {
                    "name": "ðŸ“¦ Product",
                    "value": "EcoTank Photo ET-8550 Wide-format Supertank Printer (Certified ReNew)",
                    "inline": false
                  },
                  {
                    "name": "ðŸ’° Price",
                    "value": "$479.99",
                    "inline": true
                  },
                  {
                    "name": "â° Status",
                    "value": "**IN STOCK NOW** âœ…",
                    "inline": true
                  },
                  {
                    "name": "ðŸ”— Purchase Link",
                    "value": "[**>>> CLICK HERE TO BUY NOW <<<**](https://epson.com/Certified-ReNew/All-in-One-Printers/EcoTank-Photo-ET-8550-All-in-One-Wide-format-Supertank-Printer---Certified-ReNew/p/C11CJ21201-N)",
                    "inline": false
                  }
                ],
                "thumbnail": {
                  "url": "https://cdn-icons-png.flaticon.com/512/2921/2921222.png"
                },
                "footer": {
                  "text": "Stock Tracker â€¢ Checked every 10 minutes"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }'
          echo "âœ… IN-STOCK Discord notification sent!"
      
      - name: Send Discord Notification (Still Out of Stock)
        if: steps.check.outputs.status == 'out-of-stock'
        run: |
          # Calculate if we should send hourly update (every 6 runs)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 6))
          
          if [ $REMAINDER -eq 0 ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "Stock Tracker Bot",
                "embeds": [{
                  "title": "ðŸ“Š Hourly Status Update",
                  "description": "Still monitoring - printer is currently out of stock",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "Status",
                      "value": "Out of Stock âŒ",
                      "inline": true
                    },
                    {
                      "name": "Next Check",
                      "value": "In 10 minutes",
                      "inline": true
                    }
                  ],
                  "footer": {
                    "text": "You will be notified immediately when back in stock"
                  },
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                }]
              }'
            echo "â„¹ï¸ Hourly update sent to Discord"
          else
            echo "â„¹ï¸ Skipping update (sends every hour to avoid spam)"
          fi
      
      - name: Send Discord Notification (Status Unknown)
        if: steps.check.outputs.status == 'unknown'
        run: |
          # Calculate if we should send daily alert (every 144 runs)
          RUN_NUM=${{ github.run_number }}
          REMAINDER=$((RUN_NUM % 144))
          
          if [ $REMAINDER -eq 0 ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
              -H "Content-Type: application/json" \
              -d '{
                "username": "Stock Tracker Bot",
                "embeds": [{
                  "title": "âš ï¸ Status Check Warning",
                  "description": "Unable to determine stock status clearly. Website may have changed or be temporarily down.",
                  "color": 16776960,
                  "fields": [
                    {
                      "name": "Action Needed",
                      "value": "Check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions) for details and download the page-content-debug artifact",
                      "inline": false
                    }
                  ],
                  "footer": {
                    "text": "Monitoring continues - treating as out of stock for safety"
                  },
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
                }]
              }'
            echo "âš ï¸ Unknown status alert sent"
          else
            echo "â„¹ï¸ Skipping unknown status alert (sends once per day)"
          fi